{% extends "base.html" %}

{% block title %}User Feedback - Jubair Boot House{% endblock %}

{% block content %}
<!-- Feedback Management Content -->
<section class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 text-primary mb-2">
                                <i class="fas fa-comments me-3"></i>User Feedback Management
                            </h1>
                            <p class="text-muted mb-0">View and manage all customer feedback and inquiries</p>
                        </div>
                        <div>
                            <a href="/products/admin/dashboard" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Feedback Stats -->
                <div class="row mb-4 feedback-stats">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <h4 class="mb-1">{{ feedback_list|length }}</h4>
                                <small>Total Feedback</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h4 class="mb-1">{{ feedback_list|length }}</h4>
                                <small>Total Feedback</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-envelope fa-2x mb-2"></i>
                                <h4 class="mb-1">{{ feedback_list|length }}</h4>
                                <small>Total Feedback</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <h4 class="mb-1">0</h4>
                                <small>Complaints</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Catalog Grid -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-th-large me-2 text-primary"></i>Feedback Catalog
                            </h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="exportFeedback()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="clearOldFeedback()">
                                    <i class="fas fa-trash me-2"></i>Clear Old
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if feedback_list %}
                        <div class="row g-3">
                            {% for feedback in feedback_list %}
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="feedback-card h-100" onclick="viewFeedback({{ feedback.id }})" style="cursor:pointer;">
                                    <div class="feedback-card-header">
                                        <span class="badge bg-primary"><i class="fas fa-user me-1"></i>{{ feedback.name }}</span>
                                        <span class="badge bg-secondary">#{{ feedback.id }}</span>
                                    </div>
                                    <div class="feedback-card-body">
                                        <div class="feedback-message text-muted small">{{ feedback.message[:100] }}{% if feedback.message|length > 100 %}...{% endif %}</div>
                                    </div>
                                    <div class="feedback-card-footer d-flex justify-content-between align-items-center">
                                        <small class="text-muted">{{ feedback.email }}</small>
                                        <small class="text-muted">
                                            {% if feedback.created_at %}
                                                {{ feedback.created_at.strftime('%b %d') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No feedback yet</h5>
                            <p class="text-muted">Customer feedback will appear here once they submit contact forms.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Feedback Detail Modal -->
<div class="modal fade" id="feedbackDetailModal" tabindex="-1" aria-labelledby="feedbackDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="feedbackDetailModalLabel">
                    <i class="fas fa-comment me-2"></i>Feedback Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="feedbackDetailContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="replyToFeedbackFromModal()">Reply</button>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="replyModalLabel">
                    <i class="fas fa-reply me-2"></i>Reply to Feedback
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="replyForm">
                    <div class="mb-3">
                        <label for="replyTo" class="form-label">Reply To:</label>
                        <input type="email" class="form-control" id="replyTo" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="replySubject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="replySubject" value="Re: Your Feedback - Jubair Boot House" required>
                    </div>
                    <div class="mb-3">
                        <label for="replyMessage" class="form-label">Message:</label>
                        <textarea class="form-control" id="replyMessage" rows="5" placeholder="Type your reply message..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="sendReply()">
                    <i class="fas fa-paper-plane me-2"></i>Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                    <h6 class="text-danger">Are you sure you want to delete this feedback?</h6>
                    <p class="text-muted mb-0">This action cannot be undone. The feedback will be permanently removed from the system.</p>
                </div>
                <div class="feedback-preview bg-light p-3 rounded">
                    <h6 class="mb-2"><i class="fas fa-user me-2 text-primary"></i>Feedback Details</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Name:</strong> <span id="deleteFeedbackName"></span></p>
                            <p class="mb-1"><strong>Email:</strong> <span id="deleteFeedbackEmail"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Date:</strong> <span id="deleteFeedbackDate"></span></p>
                            <p class="mb-0"><strong>Message:</strong> <span id="deleteFeedbackMessage"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteFeedback()">
                    <i class="fas fa-trash me-2"></i>Delete Feedback
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFeedbackId = null;

function showFullMessage(feedbackId) {
    // This would typically fetch the full message from the server
    // For now, we'll show a simple alert
    alert('Full message functionality would be implemented here');
}

function viewFeedback(feedbackId) {
    currentFeedbackId = feedbackId;
    
    // Fetch feedback details from server
    fetch(`/admin/feedback/${feedbackId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('feedbackDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user me-2 text-primary"></i>Name</h6>
                        <p class="mb-3">${data.name}</p>
                        
                        <h6><i class="fas fa-envelope me-2 text-primary"></i>Email</h6>
                        <p class="mb-3">${data.email}</p>
                        
                        <h6><i class="fas fa-calendar me-2 text-primary"></i>Date</h6>
                        <p class="mb-3">${new Date(data.created_at).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-comment me-2 text-primary"></i>Message</h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">${data.message.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('feedbackDetailModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching feedback:', error);
            alert('Error loading feedback details');
        });
}

function replyToFeedback(feedbackId, email) {
    currentFeedbackId = feedbackId;
    document.getElementById('replyTo').value = email;
    
    const modal = new bootstrap.Modal(document.getElementById('replyModal'));
    modal.show();
}

function replyToFeedbackFromModal() {
    if (currentFeedbackId) {
        replyToFeedback(currentFeedbackId, document.getElementById('replyTo').value);
    }
}

function sendReply() {
    const email = document.getElementById('replyTo').value;
    const subject = document.getElementById('replySubject').value;
    const message = document.getElementById('replyMessage').value;
    
    if (!message.trim()) {
        alert('Please enter a reply message');
        return;
    }
    
    // Here you would typically send the reply via email
    // For now, we'll show a success message
    alert('Reply sent successfully! (Email functionality would be implemented here)');
    
    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('replyModal'));
    modal.hide();
    document.getElementById('replyForm').reset();
}

function deleteFeedback(feedbackId) {
    currentFeedbackId = feedbackId;
    
    // Fetch feedback details to show in modal
    fetch(`/admin/feedback/${feedbackId}`)
        .then(response => response.json())
        .then(data => {
            // Populate modal with feedback details
            document.getElementById('deleteFeedbackName').textContent = data.name;
            document.getElementById('deleteFeedbackEmail').textContent = data.email;
            document.getElementById('deleteFeedbackDate').textContent = new Date(data.created_at).toLocaleString();
            document.getElementById('deleteFeedbackMessage').textContent = data.message.length > 50 ? 
                data.message.substring(0, 50) + '...' : data.message;
            
            // Show the delete confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching feedback details:', error);
            showNotification('Error loading feedback details', 'error');
        });
}

function confirmDeleteFeedback() {
    if (!currentFeedbackId) {
        showNotification('No feedback selected for deletion', 'error');
        return;
    }
    
    // Show loading state on modal button
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const originalContent = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
    confirmBtn.disabled = true;
    
    // Send delete request to server
    fetch(`/admin/feedback/${currentFeedbackId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success message
            showNotification('Feedback deleted successfully!', 'success');
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            // Remove the row from the table
            const row = document.querySelector(`tr[data-feedback-id="${currentFeedbackId}"]`);
            if (row) {
                row.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => {
                    row.remove();
                    
                    // Check if table is empty
                    const tbody = document.querySelector('tbody');
                    if (tbody.children.length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                }, 500);
            } else {
                // If row not found, reload the page
                location.reload();
            }
            
            // Reset current feedback ID
            currentFeedbackId = null;
        } else {
            throw new Error(data.message || 'Failed to delete feedback');
        }
    })
    .catch(error => {
        console.error('Error deleting feedback:', error);
        showNotification('Failed to delete feedback: ' + error.message, 'error');
        
        // Reset button state
        confirmBtn.innerHTML = originalContent;
        confirmBtn.disabled = false;
    });
}

// Reset modal state when modal is hidden
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('hidden.bs.modal', function() {
            // Reset button state
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            if (confirmBtn) {
                confirmBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Feedback';
                confirmBtn.disabled = false;
            }
            
            // Reset current feedback ID
            currentFeedbackId = null;
        });
    }
});

// Helper function to show notifications
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function exportFeedback() {
    // Here you would typically generate and download a CSV/Excel file
    alert('Export functionality would be implemented here');
}

function clearOldFeedback() {
    if (confirm('Are you sure you want to clear feedback older than 30 days? This action cannot be undone.')) {
        // Show loading state
        const clearBtn = event.target;
        const originalContent = clearBtn.innerHTML;
        clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Clearing...';
        clearBtn.disabled = true;
        
        // Send clear request to server
        fetch('/admin/feedback/clear-old', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message
                showNotification(data.message, 'success');
                
                // Reload the page to reflect changes
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                throw new Error(data.message || 'Failed to clear old feedback');
            }
        })
        .catch(error => {
            console.error('Error clearing old feedback:', error);
            showNotification('Failed to clear old feedback: ' + error.message, 'error');
            
            // Reset button state
            clearBtn.innerHTML = originalContent;
            clearBtn.disabled = false;
        });
    }
}
</script>
{% endblock %}
